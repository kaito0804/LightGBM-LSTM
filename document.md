# AIトレーディングボット 詳細仕様書

このドキュメントは、各Pythonファイルの役割、主要関数、および調整可能な設定値（パラメータ）について詳細に解説するものです。

---

## 1. main.py (司令塔・メインロジック)

**概要**:  
ボットのエントリーポイントです。市場監視、AI予測の呼び出し、トレード判断、注文実行のすべてを統括します。

### 🔑 変更可能な主要設定値 (定数)
| 変数名 | 現在地 | 説明 | 変更時の影響 |
| :--- | :--- | :--- | :--- |
| `EMERGENCY_SL_PCT` | -2.0 | 緊急時の損切りライン (%) | `-1.0`にすると、-1%の損失で即座に強制決済します（安全性UP）。 |
| `SECURE_PROFIT_TP_PCT` | 4.0 | 緊急時の利確ライン (%) | `3.0`にすると、早めに利益を確保して逃げます。 |
| `MAIN_TIMEFRAME` | '15m' | 主軸となる時間足 | `'5m'`にするとスキャルピング寄り、`'1h'`にするとデイトレ/スイング寄りになります。 |
| `BASE_THRESHOLD` | 0.53 | エントリー判定の基本閾値 | (コード内) `0.55`に上げると、より自信がある時しかエントリーしなくなります（取引回数減）。 |
| `CLOSE_THRESHOLD` | 0.55 | 決済判定の閾値 | (コード内) `0.50`に下げると、逆行予測が出た瞬間にすぐ逃げるようになります。 |

### 🛠 主要関数の詳細
- **`__init__`**:  
  各モジュール（Trader, MarketData, RiskManager, MLPredictor）を初期化し、Google SheetsロガーやWebSocket監視を起動します。

- **`get_ml_decision(market_analysis, ...)`**:  
  **最も重要な判断ロジック**です。
  1. 機械学習の予測確率 (`up_prob`, `down_prob`) を取得。
  2. 板情報 (`fast_imbalance`) やOI変化率 (`oi_delta`) で確率を補正（ブースト）します。
  3. `BASE_THRESHOLD` を超え、かつRSIなどのフィルタ条件を満たせば `BUY` / `SELL` を返します。

- **`execute_trade(decision, ...)`**:  
  AIの決定を受けて、実際に注文を出します。
  - **手数料負けガード**: 期待値 (EV) から手数料 (約0.1%) を引き、プラスでなければ注文しません。
  - **リスク管理連携**: `RiskManager` に自信度を渡し、適切なロットサイズを計算させます。

- **`run_trading_loop(interval)`**:  
  無限ループ部分です。
  - 10秒ごとに価格と緊急停止条件をチェック。
  - 指定間隔（デフォルト60秒）ごとにAI判断を行います。
  - `atr_pct` (ボラティリティ) が低すぎる (`0.3%`未満) 場合、手数料負けを防ぐため待機します。

---

## 2. risk_manager.py (資金管理・リスク管理)

**概要**:  
「いくら賭けるか」「いつ損切りするか」を計算する金庫番です。AIの自信度に応じてレバレッジを変動させる機能があります。

### 🔑 変更可能な主要設定値
| 変数名 | 現在地 | 説明 | 変更時の影響 |
| :--- | :--- | :--- | :--- |
| `CONFIDENCE_LEVELS` | 80/60/40 | 自信度のランク分け | `HIGH: 70` に上げると、AIの確信度が相当高くないと高レバを張らなくなります。 |
| `LEVERAGE_LIMITS` | 2.8/1.8/0.9 | 各ランクのレバレッジ上限 | `VERY_HIGH: 1.0` に下げると、どんなにチャンスでもレバレッジ1倍までに制限できます。 |
| `max_daily_loss` | 0.10 | 日次損失許容率 (10%) | `0.05` (5%) にすると、その日の負けが5%を超えた時点でボットが停止します。 |

### 🛠 主要関数の詳細
- **`calculate_position_size_by_confidence(...)`**:  
  AIの自信度 (`confidence`) を受け取り、ポジションサイズを決定します。
  - 自信度 80以上 → レバレッジ最大3倍目標
  - 自信度 60以上 → レバレッジ2倍目標
  - 自信度 40以上 → レバレッジ1倍目標
  - それ以下 → ポジション縮小または見送り

- **`should_add_position(...)`**:  
  既にポジションを持っている時に、さらに買い増し（ピラミッディング）して良いか判定します。リスクの取りすぎを防ぎます。

- **`check_daily_loss_limit()`**:  
  その日の累計損失を計算し、設定上限を超えていないか監視します。

---

## 3. ml_predictor.py (AI予測エンジン)

**概要**:  
LightGBM（テーブルデータ分析）とLSTM（時系列分析）を組み合わせたアンサンブルモデルで価格方向を予測します。

### 🔑 変更可能な主要設定値
| 変数名 | 現在地 | 説明 | 変更時の影響 |
| :--- | :--- | :--- | :--- |
| `feature_cols` | リスト | AIが見る指標一覧 | `'rsi'` などを削除するとその指標を無視します。`'btc_correlation'` はBTCとの連動性を重視させます。 |
| アンサンブル比率 | 0.6 : 0.4 | LGBMとLSTMの重要度 | `predict` 関数内の `lgb_up * 0.6 + lstm_up * 0.4` を変更することで、どちらのモデルを信じるか調整できます。 |

### 🛠 主要関数の詳細
- **`create_features_from_history(df)`**:  
  ローソク足データから、RSI, MACD, ボリンジャーバンド, 時間帯特徴量などを計算し、AIへの入力データを作成します。

- **`predict(df, extra_features)`**:  
  LightGBMとLSTMの両方で予測を行い、その結果を加重平均して最終的な「上昇確率」「下落確率」を出します。
  - どちらかの確率が `0.35` (35%) を超えない場合、自信度0として `HOLD` を返します。

- **`train_lightgbm` / `train_lstm`**:  
  蓄積されたデータを使ってモデルを再学習（Retrain）させます。

---

## 4. advanced_market_data.py (市場データ分析)

**概要**:  
Hyperliquid APIからデータを取得し、テクニカル分析を行う調査部門です。

### 🔑 変更可能な主要設定値
| 変数名 | 現在地 | 説明 | 変更時の影響 |
| :--- | :--- | :--- | :--- |
| `timeframe_config` | 15m/1h/4h | 分析する時間足のセット | `'5m'` を追加すれば5分足も分析対象になりますが、APIリクエスト数が増えます。 |
| `limit` | 300~500 | 取得する足の本数 | 増やすと移動平均線(SMA200など)の計算が安定しますが、通信が重くなります。 |

### 🛠 主要関数の詳細
- **`get_ohlcv(timeframe)`**:  
  指定された時間足のローソク足データを取得します。

- **`get_comprehensive_analysis()`**:  
  15分、1時間、4時間の各足でテクニカル指標を計算し、それらをまとめて市場環境（トレンド、ボラティリティ）を分析します。

- **`get_market_structure_features()`**:  
  板情報の「買い板 vs 売り板」の偏りや、BTCの価格変動を取得し、AIに追加情報として渡します。

---

## 5. improved_signal_scoring.py (旧来型テクニカル判定)

**概要**:  
AIとは別に、数理的なロジックで相場状況を点数化（スコアリング）する補助システムです。AIの判断材料の一つとして使われます。

### 🔑 変更可能な主要設定値
| 変数名 | 現在地 | 説明 | 変更時の影響 |
| :--- | :--- | :--- | :--- |
| `rsi_oversold` | 30 | RSIの売られすぎ基準 | `25` に下げると、より深い下落のみを「買い場」と判定します。 |
| `high_vol_threshold` | 5.0 | 高ボラティリティ判定値 | これを超えると「相場が荒れている」と判断し、長期足（4時間足など）を重視するようになります。 |

### 🛠 主要関数の詳細
- **`calculate_dynamic_timeframe_weights(...)`**:  
  **環境認識の要**です。
  - ボラティリティが高い時 → 4時間足の重みを増やす（ダマシ回避）。
  - レンジ相場の時 → 15分足の重みを増やす（回転重視）。
  このように、見るべき時間足の比重を自動調整します。

---

## 6. hyperliquid_sdk_trader.py (注文実行API)

**概要**:  
Hyperliquid公式SDKのラッパーです。実際に注文を出す「手」の役割です。

### 🛠 主要関数の詳細
- **`place_limit_order(..., aggressive=True)`**:  
  指値注文を出します。
  - `aggressive=True` の場合、現在価格（相手の板）にぶつける IOC注文（即時約定しなければキャンセル）を発行し、実質的な成行注文として機能させつつ、スリッページを制御します。

- **`close_position()`**:  
  保有ポジションを全決済します。

---

## 7. online_learning.py (自動学習)

**概要**:  
バックグラウンドで動き続け、定期的にAIを賢くするトレーナーです。

### 🔑 変更可能な主要設定値
| 変数名 | 現在地 | 説明 | 変更時の影響 |
| :--- | :--- | :--- | :--- |
| `retrain_interval_hours` | 24 | 再学習の間隔 (時間) | `12` にすると、1日2回モデルが更新されます。直近の相場への適応が早くなります。 |

### 🛠 主要関数の詳細
- **`retrain_models()`**:  
  1. 最新データを収集。
  2. 新しいモデルを作成。
  3. **安全性チェック**: 直近データでの精度をテストし、旧モデルより精度が悪化していれば更新を却下します（改悪防止）。

---

## 8. data_collector.py (データ収集)

**概要**:  
学習用データの収集と、正解ラベルの作成を行います。

### 🔑 変更可能な主要設定値
| 変数名 | 現在地 | 説明 | 変更時の影響 |
| :--- | :--- | :--- | :--- |
| `prediction_horizon` | 1 | 予測する未来 | `1` なら「次の足（15分後）」を予測。`4` なら「1時間後」を予測します。 |
| `neutral_threshold` | 0.3 | 変動なしとみなす幅 | ATRがない場合の予備値。この幅以内の動きは「中立」ラベルになります。 |

### 🛠 主要関数の詳細
- **`create_labels(df)`**:  
  過去データに対して、「この時買っていれば儲かったか？」という正解（1:上昇, -1:下落, 0:中立）を付与します。
  - **ATR動的閾値**: 相場のボラティリティに合わせて、「どれくらい動けば上昇とみなすか」を自動調整しています。